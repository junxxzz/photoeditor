<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="container">
        <div id="userfile_dp"></div>
        <div id="tools">
            <div class="tool" onclick="Images.reduce()">축소</div>
            <div class="tool" onclick="Images.enlarge()">확대</div>
        </div>
        <input type="file" name="userfile" id="userfile">
    </div>

    <style>
        #container {
            width: 600px;
            margin: 0 auto;
        }
        #tools {
            display: flex; gap: .5rem;
        }
        .tool {
            border: solid 1px black; padding: .5rem; user-select: none;
        }
        #userfile_dp {
            border: solid 1px black;
            width: 600px;
            height: 400px;
        }
    </style>
    <script>
        const Images = {
            pos1: 0, pos2: 0, pos3: 0, pos4: 0, offsetTop:0, offsetLeft:0, scale: 1,
            dpDiv: null,
            originalImage: null, nowImage: null, nowCanvas: null, nowPixels: null, nowCtx: null,
            attach(filefield, dpDiv) {
                Images.dpDiv = dpDiv;
                Images.dpDiv.style.overflow = 'hidden';
                Images.dpDiv.style.position = 'relative';
                filefield.addEventListener('change', Images.loadLocalImage);
            },
            loadLocalImage(evt) {
                const files = evt.target.files;
                if( !files.length ) {
                    return;
                }
                const file = files[0];
                Images.originalImage = new Image;
                Images.originalImage.src = URL.createObjectURL(file);
                Images.originalImage.crossOrigin = 'Anonymous'; // CORS
                Images.originalImage.addEventListener('load', () => Images.loadImage(Images.originalImage));
            },
            loadImage(img) {
                Images.nowImage = img;
                Images.applyImage(img);
            },
            applyImage(img) {
                Images.dpDiv.querySelector('canvas')?.remove()
                Images.nowPixels = Images.getPixels(img);
                // Images.nowCanvas = Images.makeCanvas(Images.nowImage);
                Images.dpDiv.appendChild(Images.nowCanvas);
                Images.nowCanvas.style.position = 'absolute';
                Images.nowCanvas.addEventListener('mousedown', Images.mouseDown)
                // setTimeout(() => {
                //     Images.nowCanvas.toBlob(blob => {
                //         Images.nowImage = URL.createObjectURL(blob)
                //         URL.revokeObjectURL(Images.nowImage);
                //         console.log(Images.nowImage);
                //     }, 'image/jpeg', 1)
                // }, 10);
            },
            getPixels(img, x=0, y=0, w=0, h=0) {
                if( !(img instanceof HTMLCanvasElement) ) {
                    img = Images.makeCanvas(img, Images.dpDiv.clientWidth, Images.dpDiv.clientHeight);
                    Images.nowCanvas = img;
                }
                Images.nowCtx = img.getContext('2d');
                return Images.nowCtx.getImageData(x, y, w==0?img.width:w, h==0?img.height:h);
            },
            makeCanvas(img, w, h) {
                const image = Images.createCanvas(w??img.width, h??img.height);
                Images.nowCtx = image.getContext('2d');
                if( img.width < w??img.width ) {
                    Images.offsetLeft = parseInt(w/2) - parseInt(img.width/2);
                }
                if( img.height < h??img.height ) {
                    Images.offsetTop = parseInt(h/2) - parseInt(img.height/2);
                }
                if( img instanceof ImageData ) {
                    console.log('imagedata');
                    Images.nowCtx.putImageData(img, Images.offsetLeft, Images.offsetTop)
                }
                else {
                    console.log('no imagedata');
                    Images.nowCtx.drawImage(img, Images.offsetLeft, Images.offsetTop, img.width, img.height)
                }
                return image;
            },
            createCanvas(w, h) {
                const c = document.createElement('canvas');
                c.width = w, c.height= h;
                return c;
            },
            enlarge() {
                Images.nowCtx.setTransform(1,0,0,1,0,0);
                Images.nowCtx.clearRect(0, 0, Images.dpDiv.clientWidth, Images.dpDiv.clientHeight)
                Images.scale += 0.1;
                Images.nowCtx.setTransform(Images.scale,0,0,Images.scale,0,0);
                Images.paintCanvas();
            },
            reduce() {
                Images.nowCtx.setTransform(1,0,0,1,0,0);
                Images.nowCtx.clearRect(0, 0, Images.dpDiv.clientWidth, Images.dpDiv.clientHeight)
                Images.scale -= 0.1;
                if( Images.scale <= 0 ) {
                    Images.scale = 0.1;
                }
                Images.nowCtx.setTransform(Images.scale,0,0,Images.scale,0,0);
                Images.paintCanvas();
            },
            mouseDown(evt) {
                evt.preventDefault();
                Images.pos3 = evt.clientX;
                Images.pos4 = evt.clientY;
                document.addEventListener('mouseup', Images.closeDrag)
                document.addEventListener('mousemove', Images.mouseDrag)
            },
            mouseDrag(evt) {
                evt.preventDefault();
                Images.pos1 = Images.pos3 - evt.clientX;
                Images.pos2 = Images.pos4 - evt.clientY;
                Images.pos3 = evt.clientX;
                Images.pos4 = evt.clientY;
                Images.offsetTop -= Images.pos2;
                Images.offsetLeft -= Images.pos1;
                Images.nowCtx.setTransform(1,0,0,1,0,0);
                Images.nowCtx.clearRect(0, 0, Images.dpDiv.clientWidth, Images.dpDiv.clientHeight)
                Images.nowCtx.setTransform(Images.scale,0,0,Images.scale,0,0);
                Images.paintCanvas();
            },
            closeDrag() {
                document.removeEventListener('mouseup', Images.closeDrag)
                document.removeEventListener('mousemove', Images.mouseDrag)
            },
            paintCanvas() {
                console.log('Images.scale', Images.scale);
                // if( Images.offsetLeft < 0 ) {
                //     Images.offsetLeft = 0;
                // }
                const w = Images.scale * Images.originalImage.width;
                const h = Images.scale * Images.originalImage.height;
                // if( (w - Images.dpDiv.clientWidth) > 0 && Images.offsetLeft > (w - Images.dpDiv.clientWidth) ) {
                //     Images.offsetLeft = w - Images.dpDiv.clientWidth;
                // }
                // else if( Images.offsetLeft > (Images.dpDiv.clientWidth - w) ) {
                //     Images.offsetLeft = Images.dpDiv.clientWidth - w;
                // }
                // if( Images.offsetTop < 0 ) {
                //     Images.offsetTop = 0;
                // }
                // if( Images.offsetTop > (h - Images.dpDiv.clientHeight) ) {
                //     Images.offsetTop = h - Images.dpDiv.clientHeight;
                // }
                // else if( Images.offsetTop < (Images.dpDiv.clientHeight - h) ) {
                //     Images.offsetTop = Images.dpDiv.clientHeight - h;
                // }
                Images.nowCtx.imageSmoothingQuality = 'high'
                Images.nowCtx.drawImage(Images.originalImage, Images.offsetLeft, Images.offsetTop)
                // Images.nowCtx.drawImage(Images.nowImage, Images.offsetLeft*-1, Images.offsetTop*-1)
                // Images.nowCanvas.toBlob(blob => {
                //     Images.nowImage = new Image;
                //     Images.nowImage.src = URL.createObjectURL(blob)
                //     Images.nowImage.crossOrigin = 'Anonymous'; // CORS
                // }, 'image/jpeg', 1)
            },
            crop(img, nx, ny, w, h) {
                var w = w??img.width, h = h??img.height, pix = {x:[], y:[]}, x, y, index;
                for (y = ny??0; y < h; y++) {
                    for (x = nx??0; x < w; x++) {
                        index = (y * w + x) * 4;
                        if (img.data[index+3] > 0) {
                            pix.x.push(x);
                            pix.y.push(y);
                        }
                    }
                }
                let px = 0, py = 0;
                if( pix.x.length && pix.y.length ) {
                    pix.x.sort(function(a,b){return a-b});
                    pix.y.sort(function(a,b){return a-b});
                    const n = pix.x.length-1;
                    w = 1 + pix.x[n] - pix.x[0];
                    h = 1 + pix.y[n] - pix.y[0];
                    px = pix.x[0];
                    py = pix.y[0];
                    const cut = Images.getPixels(img, w, h, px, py);
                    return cut;
                }
                else {
                    return img;
                }
            }
        };
        (function() {
            Images.attach(document.getElementById('userfile'), document.getElementById('userfile_dp'));
        })();

    </script>
</body>
</html>